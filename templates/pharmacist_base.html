{% extends "base.html" %}

{% block title %}Pharmacy Portal - MediCrypt{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Pharmacist-specific styles (consistent styling) -->
    <style>
      :root {
          /* Consistent Variables */
          --color-primary: #226da9;
          --color-secondary: #edf6fa;
          --color-accent: #f39c12; /* Pharmacist accent */
          --color-text: #223543;
          --color-subtle-bg: #f7fafc;
          --color-border: #dde6ee;
          --color-danger: #d9534f;
          --color-success: #28a745;
          --radius: 18px;
          --shadow: 0 2px 12px rgba(34, 109, 169, 0.08), 0 1.5px 5px #cbe6fa33;
          --popup-bg: #ffffff;
          --popup-shadow: 0 8px 24px rgba(34,109,169,0.12);
          --font-main: 'Inter', Arial, sans-serif;
      }
      /* Ensure body takes full height for footer push */
      html, body {
          height: 100%;
          margin: 0;
      }
      body {
          font-family: var(--font-main);
          background: var(--color-secondary);
          color: var(--color-text);
          display: flex;
          flex-direction: column;
          min-height: 100vh; /* Fallback */
      }
      .pharmacist-layout-container { /* Specific container */
          max-width: 1200px;
          width: 100%;
          margin: 0 auto;
          padding: 32px 16px 48px;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          flex-grow: 1; /* Make container take available space */
      }
      /* Header Styles */
      .dashboard-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 0 8px; margin-bottom: 32px; flex-wrap: wrap; }
      .dashboard-title { font-size: 2rem; font-weight: 600; color: var(--color-primary); letter-spacing: 1px; display: flex; align-items: center; gap: 12px; margin-top: 3px; }
      .dashboard-title i { color: var(--color-accent); font-size: 1.5rem; }
      .pharmacist-menu { display: flex; align-items: center; gap: 16px; margin-top: 2px; position: relative; }
      .pharmacist-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; border-radius: 50px; background: var(--color-subtle-bg); transition: background 0.15s; border: 1px solid transparent; outline: none; }
      .pharmacist-profile:hover { background: #dbefff; border: 1px solid var(--color-border); }
      .pharmacist-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-primary); background: white; }
      .pharmacist-name { font-size: 1rem; font-weight: 500; color: var(--color-primary); max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .btn-logout { background: var(--color-danger); color: #fff; border: none; padding: 9px 20px; border-radius: 12px; font-weight: 500; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 8px #e4717136; transition: background 0.15s; display: flex; align-items: center; gap: 10px; }
      .btn-logout:hover { background: #b43634; }
       /* General Button Styles */
       .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; font-size: 1rem; font-weight: 500; border-radius: 12px; cursor: pointer; text-decoration: none; border: none; transition: background 0.15s, box-shadow 0.15s; }
       .btn-primary { background: var(--color-primary); color: white; }
       .btn-primary:hover { background: #1a5a8f; box-shadow: 0 2px 8px #226da936; }
       .btn-success { background: var(--color-success); color: white; }
       .btn-success:hover { background: #218838; box-shadow: 0 2px 8px #28a74536; }
       .btn-secondary { background-color: #6c757d; color: white; } /* Neutral secondary */
       .btn-secondary:hover { background-color: #5a6268; }
       .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
       .btn:disabled { background-color: #ced4da; cursor: not-allowed; box-shadow: none; }

       /* Tile Styles */
       .tiles-area {
         width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive */
         gap: 34px; padding: 0 8px 36px 8px; box-sizing: border-box;
       }
       .tile {
         background: #fff; border-radius: var(--radius); box-shadow: var(--shadow);
         padding: 30px 24px; display: flex; flex-direction: column; align-items: flex-start;
         gap: 12px; min-width: 0; border: 1.5px solid var(--color-border); min-height: 160px;
         transition: box-shadow 0.17s, border 0.17s, transform 0.08s;
         position: relative; overflow: hidden; text-decoration: none; color: var(--color-text);
       }
       .tile:hover { border: 1.5px solid var(--color-primary); box-shadow: 0 2px 26px #226da91c; transform: translateY(-3px); z-index:2; }
       .tile-header { display:flex; align-items:center; gap:12px; font-size:1.25rem; font-weight:600; color:var(--color-primary); }
       .tile-header i { color: var(--color-accent); font-size:1.17rem; width: 24px; text-align: center; }
       .tile-details { font-size: 1rem; color:var(--color-text); line-height:1.45; font-weight:400; flex:1; margin-top: 5px; }
       .tile-chevron { color:var(--color-primary); position:absolute; right:20px; top:36px; font-size:1.19rem; opacity: 0.6; transition: opacity 0.2s; }
       .tile:hover .tile-chevron { opacity: 1;}
       .tile:focus-visible { border:1.5px solid var(--color-accent); box-shadow:0 2px 22px #f39c1223; outline: 2px solid var(--color-accent); outline-offset: 2px; }

      /* Common styles for content areas */
       .main-content-wrapper { flex-grow: 1; width: 100%; }
       .main-content-area { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px 24px; border: 1.5px solid var(--color-border); }
       .view-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
       .view-header h2 { font-size: 1.5rem; font-weight: 600; color: var(--color-primary); margin: 0; display: flex; align-items: center; gap: 8px; }
       .back-link { font-size: 1rem; color: var(--color-primary); text-decoration: none; display: inline-flex; align-items: center; gap: 6px; margin-right: auto; }
       .back-link:hover { text-decoration: underline; }

       /* List View Specific Styles (Prescriptions, Log) */
       .list-view-container { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px 24px; border: 1.5px solid var(--color-border); flex: 1; }
       .prescription-list { list-style: none; padding: 0; margin: 0; }
       .prescription-item {
           background: var(--color-subtle-bg); border: 1px solid var(--color-border); border-radius: 12px;
           padding: 16px 20px; margin-bottom: 16px;
           /* display: flex; flex-direction: column; gap: 12px; */ /* Let content flow naturally */
       }
       .rx-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px 20px; }
       .rx-info { flex-grow: 1; }
       .rx-patient-name { font-size: 1.1rem; font-weight: 600; color: var(--color-primary); }
       .rx-ids { font-family: monospace; font-size: 0.85rem; color: #556077; margin-top: 4px; word-break: break-all; } /* Allow break */
       .rx-actions { margin-top: 10px; /* Add space if wrapped */ }


       /* Dispensing Log Table */
       .log-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
       .log-table th, .log-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--color-border); }
       .log-table th { background-color: var(--color-subtle-bg); font-weight: 600; font-size: 0.9rem; color: #556077; }
       .log-table td { font-size: 0.95rem; }
       .log-table tr:last-child td { border-bottom: none; }
       .log-table td code { font-family: monospace; font-size: 0.9em; background: #eee; padding: 2px 4px; border-radius: 4px; }


      /* Profile popup styles */
      .profile-popup { position: absolute; right: 0; top: calc(100% + 12px); transform-origin: top right; min-width: 260px; background: var(--popup-bg); border-radius: 12px; box-shadow: var(--popup-shadow); border: 1px solid var(--color-border); padding: 14px; z-index: 40; display: none; }
      .profile-popup.visible { display: block; animation: fadeIn .12s ease-out; }
      .profile-popup header { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
      .profile-popup .pp-name { font-weight:600; color:var(--color-primary); }
      .profile-popup .pp-role { font-size:0.9rem; color:#556077; margin-top:-2px; }
      .profile-popup .pp-item { font-size:0.95rem; color:var(--color-text); margin-top:8px; }
      .profile-popup .pp-close { position:absolute; top:8px; right:8px; background:none; border:none; cursor:pointer; color:#8b98a6; font-size: 1.4rem; padding: 0; line-height: 1;}
      @keyframes fadeIn { from { opacity:0; transform: translateY(-6px); } to { opacity:1; transform:none; } }

      /* Footer styles */
      .pharmacist-footer {
          text-align: center;
          margin-top: auto; /* Push footer to bottom */
          padding: 20px 0;
          border-top: 1px solid var(--color-border);
          color: #556077;
          font-size: 0.9em;
          width: 100%;
          background-color: var(--color-secondary); /* Match body background */
       }

      /* Responsive */
       @media (max-width: 640px) {
         .dashboard-header { flex-direction: column; gap: 14px; align-items: stretch; }
         .pharmacist-menu { justify-content: space-between; }
         .pharmacist-layout-container { padding: 20px 10px 30px;}
         .tiles-area { padding: 0 10px 20px; }
         .view-header { flex-direction: column; align-items: flex-start; }
         .back-link { margin-bottom: 10px; }
         .log-table th, .log-table td { padding: 8px; font-size: 0.9em;}
         .log-table code { display: inline-block; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: bottom;}
      }
      .pharmacist-profile:focus { box-shadow: 0 0 0 3px rgba(34,109,169,0.12); border-color:var(--color-border); }
    </style>
{% endblock %}

{% block content %}
<div class="pharmacist-layout-container">
    {# Header with profile dropdown #}
    {% if user %} {# Check if user data exists #}
    <header class="dashboard-header">
      <div class="dashboard-title" aria-hidden="true">
        <i class="fas fa-prescription-bottle-alt" aria-hidden="true"></i> {# Pharmacist Icon #}
        Medicrypt â€“ Pharmacy Portal
      </div>
      <nav class="pharmacist-menu" aria-label="Account actions">
        <button class="btn-logout" type="button" aria-label="Logout" onclick="location.href='{{ url_for('logout') }}'">
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
        </button>
        <div class="pharmacist-profile" id="pharmacistProfileBtn" role="button" aria-haspopup="dialog" aria-expanded="false" tabindex="0">
          <img src="https://placehold.co/40x40/226da9/fff?text={{ (user.display_name[0] if user.display_name else user.username[0]) | upper }}" alt="Pharmacist avatar" class="pharmacist-avatar" />
          <span class="pharmacist-name">{{ user.display_name or user.username }}</span>
          <i class="fas fa-chevron-down" style="font-size:1em; color:#636a72;" aria-hidden="true"></i>
          <div class="profile-popup" id="profilePopup" role="dialog" aria-label="Pharmacist details" aria-modal="false">
            <button class="pp-close" id="ppCloseBtn" aria-label="Close profile details">&times;</button>
            <header>
              <img src="https://placehold.co/48x48/226da9/fff?text={{ (user.display_name[0] if user.display_name else user.username[0]) | upper }}" alt="" style="width:48px;height:48px;border-radius:8px;border:2px solid var(--color-primary);" />
              <div>
                <div class="pp-name">{{ user.display_name or user.username }}</div>
                <div class="pp-role">{{ user.role | capitalize if user.role else 'Pharmacist' }}</div>
              </div>
            </header>
            <div class="pp-item"><strong>Username:</strong> <span>{{ user.username }}</span></div>
            <div class="pp-item"><strong>Pharmacy:</strong> <span>{{ user.attributes.get('pharmacy', 'N/A') }}</span></div>
          </div>
        </div>
      </nav>
    </header>
    {% endif %} {# End user check #}

    {# Flash messages container #}
    <div class="flash-container" style="padding: 0 8px; margin-bottom: 24px;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {# Use base.html's alert style classes #}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Main content wrapper where child templates insert content -->
    <div class="main-content-wrapper">
        {# Define block for child pharmacist templates to fill #}
        {% block pharmacist_content %}{% endblock %}
    </div>

    <!-- Pharmacist Footer -->
    <footer class="pharmacist-footer">
        MediCrypt Secure Healthcare System &copy; 2025 | Contact: support@medicrypt.local
    </footer>
</div>

{# --- Include profile popup script in the base --- #}
{% block scripts %}
  {{ super() }} {# Include scripts from base.html if any #}
  {% if user %} {# Only add script if header is shown #}
  <script>
    // --- Script for Pharmacist profile dropdown ---
        const profileBtn = document.getElementById('pharmacistProfileBtn');
        const popup = document.getElementById('profilePopup');
        const closeBtn = document.getElementById('ppCloseBtn');

        if (!profileBtn || !popup || !closeBtn) {
            console.error("Pharmacist dropdown elements not found!");
        } else {
            function showPopup() { popup.classList.add('visible'); profileBtn.setAttribute('aria-expanded', 'true'); closeBtn.focus(); }
            function hidePopup() { popup.classList.remove('visible'); profileBtn.setAttribute('aria-expanded', 'false'); if (document.activeElement === closeBtn || popup.contains(document.activeElement)) { profileBtn.focus(); } }
            profileBtn.addEventListener('click', function(e) { e.stopPropagation(); if (popup.classList.contains('visible')) { hidePopup(); } else { showPopup(); } });
            profileBtn.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); profileBtn.click(); } else if (e.key === 'Escape' && popup.classList.contains('visible')) { hidePopup(); } });
            closeBtn.addEventListener('click', function(e) { e.stopPropagation(); hidePopup(); });
            document.addEventListener('click', function(e) { if (popup.classList.contains('visible') && !profileBtn.contains(e.target) && !popup.contains(e.target)) { hidePopup(); } });
            document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && popup.classList.contains('visible')) { hidePopup(); } });
        }
  </script>
  {% endif %}
{% endblock %}
{% endblock %} {# End block content #}

