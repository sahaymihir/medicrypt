{% extends "base.html" %}

{% block title %}Doctor Area - MediCrypt{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Doctor-specific styles (consistent with doctor_dashboard.html) -->
    <style>
      :root {
          --color-primary: #226da9;
          --color-secondary: #edf6fa;
          --color-accent: #28b094;
          --color-text: #223543;
          --color-subtle-bg: #f7fafc;
          --color-border: #dde6ee;
          --color-danger: #d9534f;
          --radius: 18px;
          --shadow: 0 2px 12px rgba(34, 109, 169, 0.08), 0 1.5px 5px #cbe6fa33;
          --popup-bg: #ffffff;
          --popup-shadow: 0 8px 24px rgba(34,109,169,0.12);
          --font-main: 'Inter', Arial, sans-serif;
      }
      body {
          font-family: var(--font-main);
          background: var(--color-secondary);
          color: var(--color-text);
          margin: 0;
          display: flex;
          flex-direction: column;
          min-height: 100vh;
      }
      .doctor-layout-container { /* Specific container for doctor layout */
          max-width: 1200px;
          width: 100%;
          margin: 0 auto;
          padding: 32px 16px 48px;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          flex-grow: 1;
      }
      .dashboard-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 0 8px; margin-bottom: 32px; flex-wrap: wrap; }
      .dashboard-title { font-size: 2rem; font-weight: 600; color: var(--color-primary); letter-spacing: 1px; display: flex; align-items: center; gap: 12px; margin-top: 3px; }
      .dashboard-title i { color: var(--color-accent); font-size: 1.5rem; }
      .doctor-menu { display: flex; align-items: center; gap: 16px; margin-top: 2px; position: relative; }
      .doctor-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; border-radius: 50px; background: var(--color-subtle-bg); transition: background 0.15s; border: 1px solid transparent; outline: none; }
      .doctor-profile:hover { background: #dbefff; border: 1px solid var(--color-border); }
      .doctor-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-primary); background: white; }
      .doctor-name { font-size: 1rem; font-weight: 500; color: var(--color-primary); max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .btn-logout { background: var(--color-danger); color: #fff; border: none; padding: 9px 20px; border-radius: 12px; font-weight: 500; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 8px #e4717136; transition: background 0.15s; display: flex; align-items: center; gap: 10px; }
      .btn-logout:hover { background: #b43634; }
      .main-content-wrapper { flex-grow: 1; width: 100%; }
      .main-content-area { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px 24px; border: 1.5px solid var(--color-border); }
      .view-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
      .view-header h2 { font-size: 1.5rem; font-weight: 600; color: var(--color-primary); margin: 0; display: flex; align-items: center; gap: 8px; }
      .back-link { font-size: 1rem; color: var(--color-primary); text-decoration: none; display: inline-flex; align-items: center; gap: 6px; margin-right: auto; }
      .back-link:hover { text-decoration: underline; }
      .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; font-size: 1rem; font-weight: 500; border-radius: 12px; cursor: pointer; text-decoration: none; border: none; transition: background 0.15s, box-shadow 0.15s; }
      .btn-primary { background: var(--color-primary); color: white; }
      .btn-primary:hover { background: #1a5a8f; box-shadow: 0 2px 8px #226da936; }
      .btn-secondary { background: var(--color-accent); color: white; }
      .btn-secondary:hover { background: #209a80; box-shadow: 0 2px 8px #28b09436; }
      .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
      .form-group { margin-bottom: 20px; }
      .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; }
      .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; font-family: inherit; }
      .form-group small { font-size: 0.85em; color: #556077; margin-top: 4px; display: block;}
      .profile-popup { position: absolute; right: 0; top: calc(100% + 12px); transform-origin: top right; min-width: 260px; background: var(--popup-bg); border-radius: 12px; box-shadow: var(--popup-shadow); border: 1px solid var(--color-border); padding: 14px; z-index: 40; display: none; }
      .profile-popup.visible { display: block; animation: fadeIn .12s ease-out; }
      .profile-popup header { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
      .profile-popup .pp-name { font-weight:600; color:var(--color-primary); }
      .profile-popup .pp-role { font-size:0.9rem; color:#556077; margin-top:-2px; }
      .profile-popup .pp-item { font-size:0.95rem; color:var(--color-text); margin-top:8px; }
      .profile-popup .pp-close { position:absolute; top:8px; right:8px; background:none; border:none; cursor:pointer; color:#8b98a6; font-size: 1.4rem; padding: 0; line-height: 1;}
      @keyframes fadeIn { from { opacity:0; transform: translateY(-6px); } to { opacity:1; transform:none; } }
      .doctor-footer { text-align: center; margin-top: auto; padding: 20px 0; border-top: 1px solid var(--color-border); color: #556077; font-size: 0.9em; width: 100%; }
      @media (max-width: 640px) {
         .dashboard-header { flex-direction: column; gap: 14px; align-items: stretch; }
         .doctor-menu { justify-content: space-between; }
         .view-header { flex-direction: column; align-items: flex-start; }
         .back-link { margin-bottom: 10px; }
         .doctor-layout-container { padding: 20px 10px 30px;}
      }
      .doctor-profile:focus { box-shadow: 0 0 0 3px rgba(34,109,169,0.12); border-color:var(--color-border); }
    </style>
{% endblock %}

{% block content %}
<div class="doctor-layout-container">
    {# Display header only if user object is available #}
    {% if user %}
      <header class="dashboard-header">
        <div class="dashboard-title" aria-hidden="true">
          <i class="fas fa-user-md" aria-hidden="true"></i>
          Medicrypt â€“ Doctor Area
        </div>
        <nav class="doctor-menu" aria-label="Account actions">
          <button class="btn-logout" type="button" aria-label="Logout" onclick="location.href='{{ url_for('logout') }}'">
            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
          </button>
          <div class="doctor-profile" id="doctorProfileBtn" role="button" aria-haspopup="dialog" aria-expanded="false" tabindex="0">
            <img src="https://placehold.co/40x40/226da9/fff?text={{ user.display_name[0] if user.display_name else 'D' }}" alt="Doctor avatar" class="doctor-avatar" />
            <span class="doctor-name" id="doctorName">{{ user.display_name or user.username }}</span>
            <i class="fas fa-chevron-down" style="font-size:1em; color:#636a72;" aria-hidden="true"></i>
            <div class="profile-popup" id="profilePopup" role="dialog" aria-label="Doctor details" aria-modal="false">
              <button class="pp-close" id="ppCloseBtn" aria-label="Close profile details">&times;</button>
              <header>
                <img src="https://placehold.co/48x48/226da9/fff?text={{ user.display_name[0] if user.display_name else 'D' }}" alt="" style="width:48px;height:48px;border-radius:8px;border:2px solid var(--color-primary);" />
                <div>
                  <div class="pp-name" id="ppName">{{ user.display_name or user.username }}</div>
                  <div class="pp-role" id="ppRole">{{ user.role | capitalize if user.role else 'Doctor' }}</div>
                </div>
              </header>
              <div class="pp-item"><strong>Email:</strong> <span id="ppEmail">{{ user.username }}</span></div>
              <div class="pp-item"><strong>Organization:</strong> <span>{{ user.get('attributes', {}).get('hospital', 'KMC') }}</span></div>
              <div class="pp-item"><strong>Department:</strong> <span>{{ user.get('attributes', {}).get('department', 'N/A') }}</span></div>
            </div>
          </div>
        </nav>
      </header>
    {% endif %}

    {# Flash messages container #}
    <div class="flash-container" style="padding: 0 8px; margin-bottom: 24px;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Wrapper for the main content area -->
    <div class="main-content-wrapper">
        {% block doctor_content %}{% endblock %} {# Define block for child doctor templates #}
    </div>

    <!-- Doctor Footer -->
    <footer class="doctor-footer">
        MediCrypt Secure Healthcare System &copy; 2025 | Contact: support@medicrypt.local
    </footer>
</div>

{# Include profile popup script #}
{% block scripts %}
  {{ super() }}
  {% if user %}
  <script>
    (function() {
      const profileBtn = document.getElementById('doctorProfileBtn');
      const popup = document.getElementById('profilePopup');
      const closeBtn = document.getElementById('ppCloseBtn');
      if (!profileBtn || !popup || !closeBtn) return;
      function showPopup() { popup.classList.add('visible'); profileBtn.setAttribute('aria-expanded', 'true'); closeBtn.focus(); }
      function hidePopup() { popup.classList.remove('visible'); profileBtn.setAttribute('aria-expanded', 'false'); if(document.activeElement === closeBtn || popup.contains(document.activeElement)) { profileBtn.focus(); } }
      profileBtn.addEventListener('click', function(e) { e.stopPropagation(); if (popup.classList.contains('visible')) hidePopup(); else showPopup(); });
      profileBtn.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); profileBtn.click(); } else if (e.key === 'Escape' && popup.classList.contains('visible')) hidePopup(); });
      closeBtn.addEventListener('click', function(e) { e.stopPropagation(); hidePopup(); });
      document.addEventListener('click', function(e) { if (popup.classList.contains('visible') && !profileBtn.contains(e.target) && !popup.contains(e.target)) hidePopup(); });
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && popup.classList.contains('visible')) hidePopup(); });
    })();
  </script>
  {% endif %}
{% endblock %}
{% endblock %} {# Added missing endblock for content #}
